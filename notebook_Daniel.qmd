---
title: "Daniel's Notebook"
format: html
---

```{r}
#| label: "libraries"
#| message: false

library(tidyverse)
library(NHANES)

```

## Data: NHANES (National Health and Nutrition Examination Survey)

We checked three different data sets:

-   ISLR, Introduction to Statistical Learning (book/package): `wages`

-   National Health and Nutrition Examination Survey: `nhanes`

-   UCI University of California, Irvine, Machine Learning Repository: `AdultUCI`

All three data sets meet the requirements for the project. Given the different analyses we will be conducting in the project, we opted for the data set with the **broadest range of variables**.

And: The topic of health also immediately **appealed to us**.

Selecting a few variables makes handling easier.

```{r}
#| label: "nhanes dataset"
#| include: false

data(NHANES)
# str(NHANES)

# Subset with ~20 variables (all types included)
nhanes_sub <- NHANES %>%
  select(
    # demographie
    SurveyYr, Gender, Age, AgeDecade, Race1, Education, MaritalStatus,
    HHIncome, HHIncomeMid, Poverty, HomeRooms, HomeOwn,
    
    # health (continuous + categorical)
    Height, Weight, BMI, HealthGen,
    Pulse, BPSysAve, BPDiaAve,
    
    # behaviour & life style
    PhysActive, PhysActiveDays, SleepHrsNight, SleepTrouble,
    Alcohol12PlusYr, AlcoholDay, AlcoholYear,
    SmokeNow, Smoke100, SmokeAge,
    
    # mental health
    DaysPhysHlthBad, DaysMentHlthBad,
    LittleInterest, Depressed
  )

str(nhanes_sub)

```

### Types of variables in the nhanes dataset: (i.e. nhanes_sub)

| Variable | Type | Description / Example |
|-------------------|-------------------|-----------------------------------|
| **SurveyYr** | categorical | Survey year (`2009_10`, `2011_12`) |
| **Gender** | binary | Gender (`male`, `female`) |
| **Age** | count | Age in years (0–80, integers) |
| **AgeDecade** | categorical | Age in decades (`20-29`, `30-39`, …) |
| **Race1** | categorical | Ethnicity (`Black`, `White`, `Mexican`, `Hispanic`, `Other`) |
| **Education** | categorical | Education level (`8th Grade`, `Some College`, …) |
| **MaritalStatus** | categorical | Marital status (`Married`, `Divorced`, `Widowed`, …) |
| **HHIncome** | categorical | Household income class (`0–4999`, `50–74k`, …) |
| **HHIncomeMid** | continuous | Median household income (numeric, in \$) |
| **Poverty** | continuous | Poverty index (income-to-poverty ratio) |
| **HomeRooms** | count | Number of rooms in the household |
| **HomeOwn** | categorical | Home ownership (`Own`, `Rent`, `Other`) |
| **Height** | continuous | Height in cm |
| **Weight** | continuous | Weight in kg |
| **BMI** | continuous | Body Mass Index |
| **HealthGen** | categorical | Self-rated health (`Excellent`, `Fair`, …) |
| **Pulse** | continuous | Resting heart rate (beats per minute) |
| **BPSysAve** | continuous | Average systolic blood pressure |
| **BPDiaAve** | continuous | Average diastolic blood pressure |
| **PhysActive** | binary | Physically active (`Yes`/`No`) |
| **PhysActiveDays** | count | Number of physically active days per week (0–7) |
| **SleepHrsNight** | count | Hours of sleep per night |
| **SleepTrouble** | binary | Trouble sleeping (`Yes`/`No`) |
| **Alcohol12PlusYr** | binary | Ever drank alcohol (≥12 drinks per year, `Yes`/`No`) |
| **AlcoholDay** | count | Number of alcoholic drinks per day |
| **AlcoholYear** | count | Number of alcoholic drinks per year |
| **SmokeNow** | binary | Currently smokes (`Yes`/`No`) |
| **Smoke100** | binary | Ever smoked ≥100 cigarettes (`Yes`/`No`) |
| **SmokeAge** | count | Age at smoking initiation |
| **DaysPhysHlthBad** | count | Days with poor physical health (0–30) |
| **DaysMentHlthBad** | count | Days with poor mental health (0–30) |
| **LittleInterest** | binary | Little interest in activities (`Yes`/`No`) |
| **Depressed** | categorical | Times feeling depressed (None, Most, Several, NAs) |

## Generalised Additive Model (family: Binomial)

### Make outcome variable Depressed (three levels) binary

```{r}
#| label: "Depressed binomial"

summary(nhanes_sub$Depressed)

nhanes_sub <- nhanes_sub %>%
  mutate(
    Depressed_bin = case_when(
      Depressed == "None" ~ "no",
      Depressed %in% c("Several", "Most") ~ "yes",
      TRUE ~ NA_character_
    ),
    Depressed_bin = factor(Depressed_bin, levels = c("no", "yes"))
  )

# Check the recode
table(nhanes_sub$Depressed, nhanes_sub$Depressed_bin, useNA = "ifany")

```

### Visual inspection of Variable Depressed_bin

```{r}
#| label: "Depressed_bin Visuals"

# Age vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = Depressed_bin, y = Age)) +
  geom_boxplot()

# SleepHrsNight vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = Depressed_bin, y = SleepHrsNight)) +
  geom_boxplot()

# Gender vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = Gender, fill = Depressed_bin)) +
  geom_bar(position = "fill")

# PhysActive vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = PhysActive, fill = Depressed_bin)) +
  geom_bar(position = "fill")

# MaritalStatus vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = MaritalStatus, fill = Depressed_bin)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle=45, hjust=1))

# BMI vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = Depressed_bin, y = BMI)) +
  geom_boxplot()

# Poverty vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = Depressed_bin, y = Poverty)) +
  geom_boxplot()

# HealthGen vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = HealthGen, fill = Depressed_bin)) +
  geom_bar(position = "fill")

# SleepTrouble vs Depressed
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = SleepTrouble, fill = Depressed_bin)) +
  geom_bar(position = "fill")

# library(ggmosaic)
# ggplot(filter(nhanes_sub, !is.na(Depressed_bin))) +
#   geom_mosaic(aes(x = product(Gender, MaritalStatus), fill = Depressed_bin)) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))

# SleepTrouble nach Gender
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), 
       aes(x = SleepTrouble, fill = Depressed_bin)) +
  geom_bar(position = "fill") +
  facet_wrap(~ Gender)

# PhysActive nach MaritalStatus
ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), 
       aes(x = PhysActive, fill = Depressed_bin)) +
  geom_bar(position = "fill") +
  facet_wrap(~ MaritalStatus)

```

### Create the models

Previous research has shown that depression is often associated with demographic, socioeconomic, social, health, and lifestyle factors. Based on these findings and after visual inspection of the graphs above, the following variables are included in the first model:

-   **Demographic**: Age, Gender\
-   **Socioeconomic**: Poverty\
-   **Social**: MaritalStatus\
-   **Health-related**: BMI, HealthGen\
-   **Sleep / Activity**: SleepHrsNight, SleepTrouble, PhysActive

These choices are supported by findings in NHANES-based studies, where factors such as poverty, marital status, physical activity, sleep problems, BMI, and general health perception were among the strongest predictors of depression (see e.g. Zhang et al., *BMC Medical Informatics and Decision Making*, 2025).

```{r}
#| label: "GLM_Binomial_1"

Depressed_data <- nhanes_sub %>%
  filter(!is.na(Depressed_bin))

glm_depressed_1 <- glm(Depressed_bin ~ Age + Gender + Poverty + MaritalStatus + BMI +
                   HealthGen + SleepHrsNight + SleepTrouble + PhysActive,
                   data = Depressed_data,
                   family = binomial)
summary(glm_depressed_1)


```

```{r}
#| label: "GLM_Binomial_missings"

vars_model <- c("Depressed_bin", "Age", "Gender", "Poverty", "MaritalStatus", "BMI", "HealthGen", "SleepHrsNight", "SleepTrouble", "PhysActive")

Depressed_data %>%
  select(all_of(vars_model)) %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
                      names_to = "Variable", values_to = "Missing_Count")



```

```{r}
#| label: "ImputeMissingsMedianExklMaritalStatus"

Depressed_data_imp <- Depressed_data %>%
  mutate(
    Poverty = ifelse(is.na(Poverty), median(Poverty, na.rm = TRUE), Poverty),
    BMI = ifelse(is.na(BMI), median(BMI, na.rm = TRUE), BMI),
    SleepHrsNight = ifelse(is.na(SleepHrsNight), median(SleepHrsNight, na.rm = TRUE), SleepHrsNight),)

Depressed_data_imp %>%
  select(all_of(vars_model)) %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
                      names_to = "Variable", values_to = "Missing_Count")

```

```{r}
#| label: "GLM_Binomial_2"

glm_depressed_2 <- glm(Depressed_bin ~ Age + Gender + Poverty + MaritalStatus + BMI +
                   HealthGen + SleepHrsNight + SleepTrouble + PhysActive,
                   data = Depressed_data_imp,
                   family = binomial)
summary(glm_depressed_2)

```

I check collinearity.

```{r}
#| label: "GLM_Binomial_2_Collinear"

library(car)
vif(glm_depressed)   # auf dein Modell anwenden


```

I doubt collinearity of HealthGen and/or SleepTrouble with Depressed. This is not an issue for the model, but for the interpretation. I could calculate two models, with and without those.